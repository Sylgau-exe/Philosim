<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ‚Äî PhiloSim</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--bg:#05050a;--bg2:#0d0d14;--card:#141420;--text:#fff;--text2:#9ca3af;--muted:#6b7280;--gold:#d4a853;--gold2:#b8923e;--purple:#6366f1;--green:#10b981;--warn:#f59e0b;--err:#ef4444;--cyan:#06b6d4;--border:rgba(255,255,255,0.06);--gborder:rgba(212,168,83,0.22);}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
    .hd{font-family:'Space Grotesk',sans-serif;}
    a{color:var(--gold);text-decoration:none;}
    ::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px;}

    .topbar{padding:16px 32px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--bg2);}
    .topbar .brand{display:flex;align-items:center;gap:10px;}
    .topbar .brand img{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--gold);}
    .topbar .brand span{font-family:'Space Grotesk';font-weight:700;font-size:20px;}
    .topbar .badge{background:var(--warn);color:#0a0a0a;padding:3px 10px;border-radius:6px;font-size:12px;font-weight:700;text-transform:uppercase;}
    .topbar .links{display:flex;gap:10px;align-items:center;}
    .btn-sm{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans';}
    .btn-gold-sm{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0a0a;}
    .btn-out-sm{background:transparent;color:var(--text2);border:1px solid var(--border);}
    .btn-danger{background:rgba(239,68,68,0.15);color:var(--err);border:1px solid rgba(239,68,68,0.3);}

    .container{max-width:1100px;margin:0 auto;padding:32px;}
    .page-title{font-family:'Space Grotesk';font-size:28px;font-weight:700;margin-bottom:24px;}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px;}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;}
    .stat .label{font-size:13px;color:var(--muted);text-transform:uppercase;font-weight:600;letter-spacing:0.05em;margin-bottom:8px;}
    .stat .value{font-family:'Space Grotesk';font-size:32px;font-weight:700;}
    .stat .sub{font-size:13px;color:var(--text2);margin-top:4px;}

    .section{margin-bottom:32px;}
    .section-title{font-family:'Space Grotesk';font-size:20px;font-weight:700;margin-bottom:16px;}

    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;border:1px solid var(--border);}
    th{text-align:left;padding:14px 16px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;font-weight:700;background:var(--bg2);border-bottom:1px solid var(--border);}
    td{padding:12px 16px;font-size:14px;border-bottom:1px solid var(--border);color:var(--text2);}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(255,255,255,0.02);}
    .tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;}
    .tag-admin{background:rgba(245,158,11,0.15);color:var(--warn);}
    .tag-free{background:rgba(107,114,128,0.15);color:var(--muted);}
    .tag-thinker{background:rgba(99,102,241,0.15);color:var(--purple);}
    .tag-philosopher{background:rgba(212,168,83,0.15);color:var(--gold);}
    .tag-google{background:rgba(66,133,244,0.15);color:#4285f4;}
    .tag-email{background:rgba(255,255,255,0.05);color:var(--text2);}
    .actions{display:flex;gap:6px;}
    .actions button{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none;font-family:'DM Sans';}
    .actions .edit{background:rgba(99,102,241,0.15);color:var(--purple);}
    .actions .del{background:rgba(239,68,68,0.1);color:var(--err);}

    /* Edit Modal */
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;}
    .modal-bg.show{display:flex;}
    .modal{background:var(--card);border:1px solid var(--gborder);border-radius:16px;padding:28px;width:100%;max-width:440px;}
    .modal h3{font-family:'Space Grotesk';font-size:22px;font-weight:700;margin-bottom:16px;}
    .modal label{display:block;font-size:13px;font-weight:600;color:var(--text2);margin-bottom:4px;}
    .modal input,.modal select{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:15px;font-family:'DM Sans';margin-bottom:12px;outline:none;}
    .modal select{cursor:pointer;}
    .modal .btns{display:flex;gap:10px;margin-top:8px;}
    .modal .btns button{flex:1;padding:10px;font-size:14px;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-family:'DM Sans';}

    /* Tabs */
    .tabs{display:flex;gap:4px;margin-bottom:28px;padding:4px;background:var(--bg2);border-radius:10px;border:1px solid var(--border);width:fit-content;}
    .tabs button{padding:10px 22px;border-radius:8px;font-size:14px;font-weight:700;border:none;cursor:pointer;font-family:'Space Grotesk';background:transparent;color:var(--muted);transition:all 0.2s;}
    .tabs button.active{background:rgba(212,168,83,0.12);color:var(--gold);border:1px solid var(--gborder);}
    .tab-content{display:none;} .tab-content.active{display:block;}

    /* Marketing cards */
    .funnel-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:28px;}
    .funnel-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;position:relative;}
    .funnel-card .f-label{font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:700;letter-spacing:0.06em;margin-bottom:6px;}
    .funnel-card .f-value{font-family:'Space Grotesk';font-size:28px;font-weight:700;}
    .funnel-card .f-sub{font-size:12px;color:var(--text2);margin-top:4px;}
    .funnel-card::after{content:'‚Üí';position:absolute;right:-10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:16px;}
    .funnel-card:last-child::after{display:none;}
    .revenue-highlight{background:linear-gradient(135deg,rgba(212,168,83,0.08),rgba(212,168,83,0.02));border:1px solid var(--gborder);}
    .campaign-table{width:100%;border-collapse:collapse;background:var(--card);border-radius:14px;overflow:hidden;border:1px solid var(--border);margin-bottom:24px;}
    .campaign-table th{text-align:left;padding:12px 14px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;font-weight:700;background:var(--bg2);border-bottom:1px solid var(--border);}
    .campaign-table td{padding:10px 14px;font-size:14px;border-bottom:1px solid var(--border);color:var(--text2);}
    .campaign-table tr:last-child td{border-bottom:none;}
    .interest-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;}
    .interest-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;align-items:center;gap:12px;}
    .interest-card img{width:40px;height:40px;border-radius:50%;border:1.5px solid var(--gold);}
    .interest-card .i-name{font-weight:700;font-size:15px;}
    .interest-card .i-count{font-family:'Space Grotesk';font-weight:700;color:var(--gold);margin-left:auto;font-size:20px;}

    @media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr);}.funnel-grid{grid-template-columns:repeat(2,1fr);}.interest-grid{grid-template-columns:1fr 1fr;}.container{padding:20px;}table{font-size:12px;}.funnel-card::after{display:none;}}
  </style>
<!-- Google Analytics GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-13L2NPBC3E"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-13L2NPBC3E');</script>
</head>
<body>

<div class="topbar">
  <div style="display:flex;align-items:center;gap:12px;">
    <a href="/" class="brand"><img src="/socrates.png" alt=""><span class="hd">PhiloSim</span></a>
    <span class="badge">Admin</span>
  </div>
  <div class="links">
    <a href="/dashboard" class="btn-sm btn-out-sm">Dashboard</a>
    <a href="/app" class="btn-sm btn-gold-sm">Play ‚Üí</a>
    <button class="btn-sm btn-out-sm" onclick="logout()">Log Out</button>
  </div>
</div>

<div class="container">
  <h1 class="page-title hd">üìä Admin Dashboard</h1>

  <div class="tabs">
    <button class="active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button onclick="switchTab('marketing')">üìà Marketing</button>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="tab-dashboard" class="tab-content active">
    <div class="stats-grid">
      <div class="stat"><div class="label">Total Users</div><div class="value" id="sUsers">‚Äî</div><div class="sub" id="sNew7d">‚Äî new this week</div></div>
      <div class="stat"><div class="label">Total Sessions</div><div class="value" id="sSessions">‚Äî</div><div class="sub" id="sSess7d">‚Äî this week</div></div>
      <div class="stat"><div class="label">Avg Wisdom Score</div><div class="value" id="sAvg" style="color:var(--gold);">‚Äî</div><div class="sub">across all sessions</div></div>
      <div class="stat"><div class="label">Plans</div><div class="value" id="sPlans" style="font-size:16px;">‚Äî</div><div class="sub">distribution</div></div>
    </div>

    <div class="section">
      <div class="section-title">üë• User Management</div>
      <table>
        <thead><tr><th>User</th><th>Plan</th><th>Auth</th><th>Sessions</th><th>Avg</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="userTable"><tr><td colspan="7" style="text-align:center;padding:32px;">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- MARKETING TAB -->
  <div id="tab-marketing" class="tab-content">
    <div class="section-title">üîª Conversion Funnel</div>
    <div class="funnel-grid" id="funnelGrid">
      <div class="funnel-card"><div class="f-label">Visitors</div><div class="f-value">‚Äî</div><div class="f-sub">see Google Analytics</div></div>
      <div class="funnel-card"><div class="f-label">Registered</div><div class="f-value" id="mRegTotal">‚Äî</div><div class="f-sub" id="mReg7d">‚Äî this week</div></div>
      <div class="funnel-card"><div class="f-label">Paid Users</div><div class="f-value" id="mPaid" style="color:var(--green);">‚Äî</div><div class="f-sub" id="mConvRate">‚Äî conv. rate</div></div>
      <div class="funnel-card"><div class="f-label">Thinkers</div><div class="f-value" id="mThinkers" style="color:var(--purple);">‚Äî</div><div class="f-sub">$19/mo each</div></div>
      <div class="funnel-card"><div class="f-label">Philosophers</div><div class="f-value" id="mPhilosophers" style="color:var(--gold);">‚Äî</div><div class="f-sub">$149 each</div></div>
    </div>

    <div class="section-title">üí∞ Revenue</div>
    <div class="stats-grid" style="margin-bottom:28px;">
      <div class="stat revenue-highlight"><div class="label">Total Revenue</div><div class="value" id="mRevTotal" style="color:var(--gold);">$0</div><div class="sub">all time</div></div>
      <div class="stat revenue-highlight"><div class="label">Marina's Share (80%)</div><div class="value" id="mRevMarina" style="color:var(--green);">$0</div><div class="sub">commission earned</div></div>
      <div class="stat"><div class="label">Monthly Recurring</div><div class="value" id="mMRR" style="color:var(--purple);">$0</div><div class="sub">from Thinker plans</div></div>
      <div class="stat"><div class="label">One-Time Revenue</div><div class="value" id="mOneTime">$0</div><div class="sub">from Philosopher plans</div></div>
    </div>

    <div class="section-title">üì£ Campaign Performance</div>
    <table class="campaign-table">
      <thead><tr><th>Source</th><th>Medium</th><th>Campaign</th><th>Signups</th><th>Conversions</th><th>Conv %</th></tr></thead>
      <tbody id="campaignTable"><tr><td colspan="6" style="text-align:center;padding:24px;color:var(--muted);">No campaign data yet. Use UTM links to track!</td></tr></tbody>
    </table>

    <div class="section-title">üèõÔ∏è Philosopher Interest</div>
    <p style="color:var(--text2);font-size:14px;margin:-8px 0 16px;">Which mentors are people excited about? ("Notify Me" clicks)</p>
    <div class="interest-grid" id="interestGrid">
      <div style="grid-column:1/-1;text-align:center;padding:24px;color:var(--muted);">No interest data yet.</div>
    </div>

    <div class="section-title">üïê Recent Signups</div>
    <table class="campaign-table">
      <thead><tr><th>Name</th><th>Source</th><th>Campaign</th><th>Auth</th><th>Plan</th><th>Date</th></tr></thead>
      <tbody id="recentSignups"><tr><td colspan="6" style="text-align:center;padding:24px;">Loading...</td></tr></tbody>
    </table>

    <div class="section" style="margin-top:28px;">
      <div class="section-title">üîó UTM Link Builder</div>
      <p style="color:var(--text2);font-size:14px;margin-bottom:12px;">Use these links in social media posts so you can track which campaigns bring signups:</p>
      <div class="card" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;">
        <div style="display:grid;gap:8px;margin-bottom:12px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="width:80px;font-size:13px;font-weight:600;color:var(--text2);">Source</label>
            <input id="utmSource" placeholder="e.g. instagram, facebook, tiktok, linkedin" style="flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:'DM Sans';">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="width:80px;font-size:13px;font-weight:600;color:var(--text2);">Medium</label>
            <input id="utmMedium" placeholder="e.g. social, email, paid, story, reel" style="flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:'DM Sans';">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="width:80px;font-size:13px;font-weight:600;color:var(--text2);">Campaign</label>
            <input id="utmCampaign" placeholder="e.g. launch-feb, socrates-promo, spring-2026" style="flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:'DM Sans';">
          </div>
        </div>
        <div style="background:var(--bg);border:1px solid var(--gborder);border-radius:8px;padding:12px;font-size:13px;font-family:monospace;color:var(--gold);word-break:break-all;" id="utmResult">https://philosim.app/?utm_source=...&utm_medium=...&utm_campaign=...</div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn-sm btn-gold-sm" onclick="buildUTM()">Generate Link</button>
          <button class="btn-sm btn-out-sm" onclick="copyUTM()">Copy</button>
        </div>
      </div>
    </div>

    <div class="section" style="margin-top:20px;">
      <div class="section-title">üìä Google Analytics</div>
      <p style="color:var(--text2);font-size:14px;">For visitor count and traffic sources, set up Google Analytics 4. Add your GA4 Measurement ID in the code (search for <code style="color:var(--gold);">G-13L2NPBC3E</code>).</p>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-bg" id="editModal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <h3 class="hd">Edit User</h3>
    <input type="hidden" id="editId">
    <label>Name</label><input id="editName" placeholder="Name">
    <label>Email</label><input id="editEmail" placeholder="Email">
    <label>Plan</label>
    <select id="editPlan"><option value="free">Explorer (Free)</option><option value="thinker">Thinker</option><option value="philosopher">Philosopher</option></select>
    <label>Admin</label>
    <select id="editAdmin"><option value="false">No</option><option value="true">Yes</option></select>
    <div class="btns">
      <button style="background:var(--border);color:var(--text2);" onclick="document.getElementById('editModal').classList.remove('show')">Cancel</button>
      <button style="background:linear-gradient(135deg,var(--purple),#7c3aed);color:#fff;" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<script>
// Pick up auth token from cookie
(function() {
  const match = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
  if (match) {
    localStorage.setItem('auth_token', match[1]);
    document.cookie = 'auth_token=; Path=/; Max-Age=0';
  }
})();

const token = localStorage.getItem('auth_token');
if (!token) {
  const cookieMatch = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
  if (cookieMatch) { localStorage.setItem('auth_token', cookieMatch[1]); window.location.reload(); }
  else window.location.href = '/';
}
const H = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

async function loadStats() {
  try {
    const r = await fetch('/api/admin/stats', { headers: H });
    if (r.status === 403) { alert('Admin access required'); window.location.href = '/dashboard'; return; }
    if (!r.ok) return;
    const d = await r.json();
    document.getElementById('sUsers').textContent = d.overview.totalUsers;
    document.getElementById('sSessions').textContent = d.overview.totalSessions;
    document.getElementById('sAvg').textContent = d.overview.avgScore || '‚Äî';
    document.getElementById('sNew7d').textContent = (d.last7Days.newUsers || 0) + ' new this week';
    document.getElementById('sSess7d').textContent = (d.last7Days.sessions || 0) + ' this week';
    if (d.planDistribution && d.planDistribution.length > 0) {
      document.getElementById('sPlans').textContent = d.planDistribution.map(p => `${p.plan || 'free'}: ${p.count}`).join(' ¬∑ ');
    }
  } catch(e) { console.error(e); }
}

async function loadUsers() {
  try {
    const r = await fetch('/api/admin/users', { headers: H });
    if (!r.ok) return;
    const { users } = await r.json();
    const tb = document.getElementById('userTable');
    tb.innerHTML = users.map(u => `<tr>
      <td><strong style="color:var(--text)">${u.name || '‚Äî'}</strong><br><span style="font-size:12px">${u.email}</span></td>
      <td><span class="tag tag-${u.plan || 'free'}">${u.plan || 'free'}</span>${u.isAdmin ? ' <span class="tag tag-admin">admin</span>' : ''}</td>
      <td><span class="tag tag-${u.authProvider}">${u.authProvider}</span></td>
      <td>${u.sessions}</td>
      <td>${u.avgScore || '‚Äî'}</td>
      <td>${u.joined}</td>
      <td class="actions">
        <button class="edit" onclick='editUser(${JSON.stringify(u)})'>Edit</button>
        <button class="del" onclick="deleteUser(${u.id},'${u.email}')">Del</button>
      </td>
    </tr>`).join('');
  } catch(e) { console.error(e); }
}

function editUser(u) {
  document.getElementById('editId').value = u.id;
  document.getElementById('editName').value = u.name || '';
  document.getElementById('editEmail').value = u.email || '';
  document.getElementById('editPlan').value = u.plan || 'free';
  document.getElementById('editAdmin').value = u.isAdmin ? 'true' : 'false';
  document.getElementById('editModal').classList.add('show');
}

async function saveEdit() {
  const userId = parseInt(document.getElementById('editId').value);
  const body = {
    userId,
    name: document.getElementById('editName').value,
    email: document.getElementById('editEmail').value,
    plan: document.getElementById('editPlan').value,
    isAdmin: document.getElementById('editAdmin').value === 'true',
  };
  try {
    const r = await fetch('/api/admin/edit-user', { method: 'POST', headers: H, body: JSON.stringify(body) });
    if (!r.ok) { const err = await r.json(); alert(err.error || 'Failed'); return; }
    document.getElementById('editModal').classList.remove('show');
    loadUsers(); loadStats();
  } catch(e) { alert('Failed to update'); }
}

async function deleteUser(id, email) {
  if (!confirm(`Delete ${email}? This cannot be undone.`)) return;
  try {
    await fetch('/api/admin/delete-user', { method: 'DELETE', headers: H, body: JSON.stringify({ userId: id }) });
    loadUsers(); loadStats();
  } catch(e) { alert('Failed to delete'); }
}

function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }

// ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
  if (tab === 'marketing' && !marketingLoaded) loadMarketing();
}

// ‚îÄ‚îÄ Marketing Dashboard ‚îÄ‚îÄ
let marketingLoaded = false;
const philosopherNames = { socrates:'Socrates', plato:'Plato', aristotle:'Aristotle', kant:'Kant', nietzsche:'Nietzsche', beauvoir:'Beauvoir' };
const philosopherAvatars = { socrates:'/socrates.png', plato:'/plato.png', aristotle:'/aristotle.png', kant:'/kant.png', nietzsche:'/nietzsche.png', beauvoir:'/beauvoir.png' };

async function loadMarketing() {
  try {
    const r = await fetch('/api/admin/marketing', { headers: H });
    if (!r.ok) return;
    const d = await r.json();
    marketingLoaded = true;

    // Funnel
    document.getElementById('mRegTotal').textContent = d.funnel.totalUsers;
    document.getElementById('mPaid').textContent = d.funnel.paidUsers;
    document.getElementById('mConvRate').textContent = d.funnel.conversionRate + '% conv. rate';
    document.getElementById('mThinkers').textContent = d.funnel.thinkers;
    document.getElementById('mPhilosophers').textContent = d.funnel.philosophers;
    // Week count
    const weekRegs = d.regsByDay.reduce((sum, r) => {
      const dayDate = new Date(r.day);
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      return dayDate >= weekAgo ? sum + parseInt(r.count) : sum;
    }, 0);
    document.getElementById('mReg7d').textContent = weekRegs + ' this week';

    // Revenue
    document.getElementById('mRevTotal').textContent = '$' + d.revenue.total;
    document.getElementById('mRevMarina').textContent = '$' + d.revenue.marina80;
    document.getElementById('mMRR').textContent = '$' + d.revenue.thinker + '/mo';
    document.getElementById('mOneTime').textContent = '$' + d.revenue.philosopher;

    // Campaigns
    if (d.campaigns && d.campaigns.length > 0) {
      document.getElementById('campaignTable').innerHTML = d.campaigns.map(c => {
        const convPct = parseInt(c.signups) > 0 ? ((parseInt(c.conversions)/parseInt(c.signups))*100).toFixed(0) : '0';
        return `<tr>
          <td><strong style="color:var(--text)">${c.source}</strong></td>
          <td>${c.medium}</td>
          <td>${c.campaign}</td>
          <td style="font-weight:700;">${c.signups}</td>
          <td style="color:var(--green);font-weight:700;">${c.conversions}</td>
          <td>${convPct}%</td>
        </tr>`;
      }).join('');
    }

    // Philosopher Interest
    if (d.philosopherInterest && d.philosopherInterest.length > 0) {
      document.getElementById('interestGrid').innerHTML = d.philosopherInterest.map(p => `
        <div class="interest-card">
          <img src="${philosopherAvatars[p.philosopher_id] || '/socrates.png'}" alt="${p.philosopher_id}">
          <div class="i-name">${philosopherNames[p.philosopher_id] || p.philosopher_id}</div>
          <div class="i-count">${p.interest_count}</div>
        </div>
      `).join('');
    }

    // Recent signups
    if (d.recentSignups && d.recentSignups.length > 0) {
      document.getElementById('recentSignups').innerHTML = d.recentSignups.map(u => `<tr>
        <td><strong style="color:var(--text)">${u.name || '‚Äî'}</strong></td>
        <td>${u.utm_source || '<span style="color:var(--muted)">direct</span>'}</td>
        <td>${u.utm_campaign || '<span style="color:var(--muted)">‚Äî</span>'}</td>
        <td><span class="tag tag-${u.auth_provider}">${u.auth_provider}</span></td>
        <td><span class="tag tag-${u.plan || 'free'}">${u.plan || 'free'}</span></td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
      </tr>`).join('');
    }
  } catch(e) { console.error('Marketing load error:', e); }
}

// ‚îÄ‚îÄ UTM Link Builder ‚îÄ‚îÄ
function buildUTM() {
  const s = document.getElementById('utmSource').value.trim();
  const m = document.getElementById('utmMedium').value.trim();
  const c = document.getElementById('utmCampaign').value.trim();
  let url = 'https://philosim.app/';
  const params = [];
  if (s) params.push('utm_source=' + encodeURIComponent(s));
  if (m) params.push('utm_medium=' + encodeURIComponent(m));
  if (c) params.push('utm_campaign=' + encodeURIComponent(c));
  if (params.length) url += '?' + params.join('&');
  document.getElementById('utmResult').textContent = url;
}

function copyUTM() {
  const text = document.getElementById('utmResult').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}

loadStats();
loadUsers();
</script>
</body>
</html>
