<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Dashboard â€” PhiloSim</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--bg:#05050a;--bg2:#0d0d14;--card:#141420;--text:#fff;--text2:#9ca3af;--muted:#6b7280;--gold:#d4a853;--gold2:#b8923e;--purple:#6366f1;--green:#10b981;--warn:#f59e0b;--err:#ef4444;--cyan:#06b6d4;--border:rgba(255,255,255,0.06);--gborder:rgba(212,168,83,0.22);--gglow:rgba(212,168,83,0.15);}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
    .hd{font-family:'Space Grotesk',sans-serif;}
    a{color:var(--gold);text-decoration:none;}
    ::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px;}

    .topbar{padding:16px 32px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--bg2);}
    .topbar .brand{display:flex;align-items:center;gap:10px;}
    .topbar .brand img{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--gold);}
    .topbar .brand span{font-family:'Space Grotesk';font-weight:700;font-size:20px;}
    .topbar .links{display:flex;gap:12px;align-items:center;}
    .topbar .links a{padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;}
    .topbar .links .active{background:rgba(212,168,83,0.1);color:var(--gold);border:1px solid var(--gborder);}
    .lang-toggle{display:flex;gap:2px;padding:2px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;}
    .lang-toggle button{padding:4px 10px;font-size:11px;font-weight:700;background:transparent;color:var(--muted);border:none;border-radius:4px;cursor:pointer;font-family:'DM Sans';transition:all 0.2s;}
    .lang-toggle button.active{background:rgba(212,168,83,0.12);color:var(--gold);}
    .btn-sm{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans';}
    .btn-gold-sm{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0a0a;}
    .btn-out-sm{background:transparent;color:var(--text2);border:1px solid var(--border);}

    .container{max-width:1000px;margin:0 auto;padding:32px;}
    .welcome{margin-bottom:32px;}
    .welcome h1{font-family:'Space Grotesk';font-size:32px;font-weight:700;}
    .welcome p{color:var(--text2);font-size:17px;margin-top:4px;}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px;}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;}
    .stat-card .label{font-size:13px;color:var(--muted);text-transform:uppercase;font-weight:600;letter-spacing:0.05em;margin-bottom:8px;}
    .stat-card .value{font-family:'Space Grotesk';font-size:32px;font-weight:700;}
    .stat-card .sub{font-size:13px;color:var(--text2);margin-top:4px;}

    .section-title{font-family:'Space Grotesk';font-size:22px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
    .plan-card{background:var(--card);border:1px solid var(--gborder);border-radius:14px;padding:24px;display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;}
    .plan-card .plan-name{font-family:'Space Grotesk';font-size:20px;font-weight:700;color:var(--gold);}
    .plan-card .plan-desc{color:var(--text2);font-size:15px;margin-top:4px;}

    .session-list{display:flex;flex-direction:column;gap:12px;margin-bottom:32px;}
    .session-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s;cursor:default;}
    .session-item:hover{border-color:var(--gborder);}
    .session-item .info h3{font-family:'Space Grotesk';font-size:17px;font-weight:700;}
    .session-item .info p{font-size:14px;color:var(--muted);}
    .session-item .score{font-family:'Space Grotesk';font-size:28px;font-weight:700;}
    .empty{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:48px;text-align:center;color:var(--text2);}
    .empty p{margin-bottom:16px;}

    @media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr);}.container{padding:20px;}}
  </style>
<!-- Google Analytics GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-13L2NPBC3E"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-13L2NPBC3E');</script>
</head>
<body>

<div class="topbar">
  <a href="/" class="brand"><img src="/socrates.png" alt=""><span class="hd">PhiloSim</span></a>
  <div class="links">
    <div class="lang-toggle">
      <button onclick="setLang('en')">EN</button>
      <button onclick="setLang('fr')">FR</button>
    </div>
    <a href="/choose" data-i18n="nav_mentors">Mentors</a>
    <a href="/dashboard" class="active" data-i18n="nav_dashboard">Dashboard</a>
    <a href="/choose" class="btn-sm btn-gold-sm" data-i18n="nav_play">Play â†’</a>
    <button class="btn-sm btn-out-sm" onclick="logout()" data-i18n="nav_logout">Log Out</button>
  </div>
</div>

<div class="container">
  <div class="welcome">
    <h1 class="hd"><span data-i18n="dash_welcome">Welcome back,</span> <span id="userName">...</span></h1>
    <p data-i18n="dash_subtitle">Your philosophical journey at a glance.</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="label" data-i18n="stat_sessions">Sessions</div>
      <div class="value" id="statSessions">0</div>
      <div class="sub" data-i18n="stat_sessions_sub">simulations completed</div>
    </div>
    <div class="stat-card">
      <div class="label" data-i18n="stat_best">Best Score</div>
      <div class="value" id="statBest" style="color:var(--green);">â€”</div>
      <div class="sub" data-i18n="stat_best_sub">highest wisdom score</div>
    </div>
    <div class="stat-card">
      <div class="label" data-i18n="stat_avg">Avg Score</div>
      <div class="value" id="statAvg" style="color:var(--gold);">â€”</div>
      <div class="sub" data-i18n="stat_avg_sub">average across sessions</div>
    </div>
    <div class="stat-card">
      <div class="label" data-i18n="stat_member">Member Since</div>
      <div class="value" id="statJoined" style="font-size:20px;">â€”</div>
      <div class="sub" id="statPlan" data-i18n="stat_free">Free plan</div>
    </div>
  </div>

  <div class="plan-card" id="planCard">
    <div>
      <div class="plan-name" id="planName">Explorer</div>
      <div class="plan-desc" id="planDesc" data-i18n="plan_desc_free">1 scenario with Socrates. Upgrade for full access.</div>
    </div>
    <a href="/#pricing" class="btn-sm btn-gold-sm" id="upgradeBtn" data-i18n="btn_upgrade">Upgrade â†’</a>
  </div>

  <div class="section-title" data-i18n="section_history">ðŸ“œ Session History</div>
  <div id="sessionList" class="session-list">
    <div class="empty"><p data-i18n="empty_sessions">No sessions completed yet.</p><a href="/choose" class="btn-sm btn-gold-sm" data-i18n="btn_first_sim">Start Your First Simulation â†’</a></div>
  </div>
</div>

<script>
// â”€â”€ Cookie â†’ localStorage bridge â”€â”€
(function() {
  const match = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
  if (match) {
    localStorage.setItem('auth_token', match[1]);
    document.cookie = 'auth_token=; Path=/; Max-Age=0';
  }
})();

const token = localStorage.getItem('auth_token');
if (!token) {
  const cookieMatch = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
  if (cookieMatch) {
    localStorage.setItem('auth_token', cookieMatch[1]);
    window.location.reload();
  } else {
    window.location.href = '/?login=1';
  }
}

// â”€â”€ i18n â”€â”€
const i18n = {
  en: {
    nav_mentors: 'Mentors', nav_dashboard: 'Dashboard', nav_play: 'Play â†’', nav_logout: 'Log Out',
    dash_welcome: 'Welcome back,', dash_subtitle: 'Your philosophical journey at a glance.',
    stat_sessions: 'Sessions', stat_sessions_sub: 'simulations completed',
    stat_best: 'Best Score', stat_best_sub: 'highest wisdom score',
    stat_avg: 'Avg Score', stat_avg_sub: 'average across sessions',
    stat_member: 'Member Since', stat_free: 'Free plan',
    plan_desc_free: '1 scenario with Socrates. Upgrade for full access.',
    plan_desc_paid: 'Full access to all mentors and scenarios.',
    btn_upgrade: 'Upgrade â†’', btn_manage: 'Manage Subscription â†’',
    section_history: 'ðŸ“œ Session History',
    empty_sessions: 'No sessions completed yet.',
    btn_first_sim: 'Start Your First Simulation â†’',
    decisions: 'decisions', simulation: 'Simulation',
    plan_explorer: 'Explorer', plan_thinker: 'Thinker ($19/mo)', plan_philosopher: 'Philosopher (Lifetime)',
    toast_payment: 'Payment successful! Welcome to '
  },
  fr: {
    nav_mentors: 'Mentors', nav_dashboard: 'Tableau de bord', nav_play: 'Jouer â†’', nav_logout: 'DÃ©connexion',
    dash_welcome: 'Bon retour,', dash_subtitle: 'Votre parcours philosophique en un coup d\'Å“il.',
    stat_sessions: 'Sessions', stat_sessions_sub: 'simulations complÃ©tÃ©es',
    stat_best: 'Meilleur', stat_best_sub: 'score de sagesse le plus Ã©levÃ©',
    stat_avg: 'Moyenne', stat_avg_sub: 'moyenne de toutes les sessions',
    stat_member: 'Membre depuis', stat_free: 'Forfait gratuit',
    plan_desc_free: '1 scÃ©nario avec Socrate. Passez au forfait supÃ©rieur pour un accÃ¨s complet.',
    plan_desc_paid: 'AccÃ¨s complet Ã  tous les mentors et scÃ©narios.',
    btn_upgrade: 'Passer au supÃ©rieur â†’', btn_manage: 'GÃ©rer l\'abonnement â†’',
    section_history: 'ðŸ“œ Historique des sessions',
    empty_sessions: 'Aucune session complÃ©tÃ©e.',
    btn_first_sim: 'Commencez votre premiÃ¨re simulation â†’',
    decisions: 'dÃ©cisions', simulation: 'Simulation',
    plan_explorer: 'Explorateur', plan_thinker: 'Penseur (19$/mois)', plan_philosopher: 'Philosophe (Ã€ vie)',
    toast_payment: 'Paiement rÃ©ussi! Bienvenue dans le forfait '
  }
};

let currentLang = localStorage.getItem('philosim_lang') || 'en';
function t(key) { return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key; }

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('philosim_lang', lang);
  document.querySelectorAll('.lang-toggle button').forEach(b => b.classList.toggle('active', b.textContent.trim() === lang.toUpperCase()));
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[lang][key]) el.textContent = i18n[lang][key];
  });
  updatePlanDisplay();
}

// Apply lang on load
document.querySelectorAll('.lang-toggle button').forEach(b => b.classList.toggle('active', b.textContent.trim() === currentLang.toUpperCase()));
if (currentLang !== 'en') {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
  });
}

let currentPlan = 'free';

function updatePlanDisplay() {
  const planNames = { free: t('plan_explorer'), thinker: t('plan_thinker'), philosopher: t('plan_philosopher') };
  document.getElementById('planName').textContent = planNames[currentPlan] || planNames.free;
  document.getElementById('statPlan').textContent = planNames[currentPlan] || t('stat_free');
  if (currentPlan !== 'free') {
    document.getElementById('planDesc').textContent = t('plan_desc_paid');
  } else {
    document.getElementById('planDesc').textContent = t('plan_desc_free');
  }
}

async function loadDashboard() {
  try {
    const r = await fetch('/api/auth/me', { headers: {'Authorization':'Bearer ' + token} });
    if (!r.ok) { window.location.href = '/'; return; }
    const { user } = await r.json();
    document.getElementById('userName').textContent = (user.name || 'Philosopher').split(' ')[0];
    const locale = currentLang === 'fr' ? 'fr-CA' : 'en';
    document.getElementById('statJoined').textContent = new Date(user.createdAt).toLocaleDateString(locale, {month:'short', year:'numeric'});
    currentPlan = user.plan || 'free';
    updatePlanDisplay();

    if (currentPlan !== 'free') {
      const upgradeBtn = document.getElementById('upgradeBtn');
      if (currentPlan === 'thinker') {
        upgradeBtn.textContent = t('btn_manage');
        upgradeBtn.onclick = async (e) => {
          e.preventDefault();
          try {
            const sr = await fetch('/api/stripe/status', { headers: {'Authorization':'Bearer ' + token} });
            const sd = await sr.json();
            if (sd.portalUrl) window.location.href = sd.portalUrl;
          } catch(e) {}
        };
        upgradeBtn.href = '#';
      } else {
        upgradeBtn.style.display = 'none';
      }
    }

    if (user.isAdmin) {
      const links = document.querySelector('.topbar .links');
      const adminLink = document.createElement('a');
      adminLink.href = '/admin';
      adminLink.textContent = 'Admin';
      links.insertBefore(adminLink, links.firstChild);
    }
  } catch(e) { console.error(e); }
}

async function loadSessions() {
  let sessions = [];
  let stats = null;
  try {
    const r = await fetch('/api/sessions/history', { headers: {'Authorization':'Bearer ' + token} });
    if (r.ok) {
      const data = await r.json();
      const locale = currentLang === 'fr' ? 'fr-CA' : 'en';
      sessions = data.sessions.map(s => ({
        scenarioTitle: s.scenarioTitle, overall: s.overall, date: new Date(s.date).toLocaleDateString(locale),
        decisions: s.decisions?.length || 5
      }));
      stats = data.stats;
    }
  } catch(e) {}

  const localSessions = JSON.parse(localStorage.getItem('philosim_sessions') || '[]');
  if (sessions.length === 0 && localSessions.length > 0) sessions = localSessions;

  const list = document.getElementById('sessionList');
  if (sessions.length === 0) return;
  list.innerHTML = '';
  sessions.forEach(s => {
    const color = s.overall >= 80 ? 'var(--green)' : s.overall >= 60 ? 'var(--gold)' : 'var(--warn)';
    list.innerHTML += `<div class="session-item">
      <div class="info"><h3 class="hd">${s.scenarioTitle || t('simulation')}</h3><p>${s.date || ''} Â· ${s.decisions || 5} ${t('decisions')}</p></div>
      <div class="score" style="color:${color}">${s.overall}/100</div>
    </div>`;
  });

  if (stats && stats.total > 0) {
    document.getElementById('statBest').textContent = stats.bestScore;
    document.getElementById('statAvg').textContent = stats.avgScore;
    document.getElementById('statSessions').textContent = stats.total;
  } else if (sessions.length > 0) {
    const best = Math.max(...sessions.map(s => s.overall));
    const avg = Math.round(sessions.reduce((s,x) => s + x.overall, 0) / sessions.length);
    document.getElementById('statBest').textContent = best;
    document.getElementById('statAvg').textContent = avg;
    document.getElementById('statSessions').textContent = sessions.length;
  }
}

// Payment toast
const params = new URLSearchParams(window.location.search);
if (params.get('payment') === 'success') {
  window.history.replaceState({}, '', '/dashboard');
  setTimeout(() => {
    const planLabel = params.get('plan') === 'philosopher' ? (currentLang==='fr'?'Philosophe':'Philosopher') : (currentLang==='fr'?'Penseur':'Thinker');
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:24px;right:24px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0a0a;padding:16px 24px;border-radius:12px;font-weight:700;font-family:Space Grotesk;z-index:9999;animation:fadeIn 0.3s;box-shadow:0 8px 32px rgba(212,168,83,0.4);';
    toast.textContent = 'âœ… ' + t('toast_payment') + planLabel + '!';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }, 500);
}

function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }

loadDashboard();
loadSessions();
</script>
</body>
</html>
