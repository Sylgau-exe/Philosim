<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhiloSim ‚Äî Simulation</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--bg:#05050a;--bg2:#0d0d14;--card:#141420;--card2:#1a1a28;--text:#fff;--text2:#9ca3af;--muted:#6b7280;--gold:#d4a853;--gold2:#b8923e;--purple:#6366f1;--purple2:#8b5cf6;--green:#10b981;--warn:#f59e0b;--err:#ef4444;--cyan:#06b6d4;--border:rgba(255,255,255,0.06);--gborder:rgba(212,168,83,0.22);--gglow:rgba(212,168,83,0.15);}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden;}
    .hd{font-family:'Space Grotesk',sans-serif;}
    a{color:var(--gold);text-decoration:none;}
    ::selection{background:rgba(212,168,83,0.3);}
    ::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    .fade{animation:fadeUp 0.4s ease;}
    button{cursor:pointer;font-family:'DM Sans';}

    /* SIDEBAR */
    .sidebar{width:240px;min-width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
    .sb-brand{padding:20px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
    .sb-brand img{width:36px;height:36px;border-radius:10px;border:2px solid var(--gold);}
    .sb-brand .t{font-family:'Space Grotesk';font-weight:700;font-size:22px;}
    .sb-brand .s{font-size:11px;color:var(--gold);text-transform:uppercase;letter-spacing:0.05em;}
    .sb-lang{padding:10px 18px 0;display:flex;gap:4px;}
    .sb-lang button{flex:1;padding:5px;font-size:13px;background:transparent;color:var(--muted);border:1px solid transparent;border-radius:6px;}
    .sb-lang button.active{font-weight:700;background:rgba(212,168,83,0.12);color:var(--gold);border-color:var(--gborder);}
    .sb-nav{padding:12px 8px;flex:1;display:flex;flex-direction:column;gap:2px;}
    .sb-nav button{display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent;color:var(--text2);border:none;border-radius:8px;font-size:16px;width:100%;text-align:left;transition:all 0.2s;}
    .sb-nav button.active{background:rgba(212,168,83,0.1);color:var(--gold);font-weight:600;}
    .sb-nav button span.icon{font-size:18px;flex-shrink:0;}
    .sb-nav button span.badge{margin-left:auto;font-size:10px;font-weight:700;color:var(--muted);background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:4px;}
    .sb-foot{padding:12px;border-top:1px solid var(--border);}
    .sb-foot a{display:block;padding:8px 12px;font-size:14px;color:var(--text2);border-radius:8px;text-align:center;}
    .sb-foot a:hover{background:rgba(255,255,255,0.03);}

    /* MAIN */
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .journey-bar{padding:14px 28px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;}
    .jb-step{display:flex;align-items:center;flex:1;cursor:pointer;}
    .jb-step .dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;margin-right:8px;}
    .jb-step .dot.done{background:rgba(16,185,129,0.15);color:var(--green);border:2px solid var(--green);}
    .jb-step .dot.active{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0a0a;}
    .jb-step .dot.future{background:rgba(255,255,255,0.05);color:var(--muted);}
    .jb-step .info .label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;}
    .jb-step .info .title{font-size:14px;font-weight:600;}
    .jb-line{flex:1;height:2px;margin:0 16px;}

    .content{flex:1;overflow-y:auto;padding:28px;display:flex;justify-content:center;}
    .content-inner{max-width:800px;width:100%;}

    .btn{display:inline-block;padding:14px 32px;border-radius:10px;font-weight:600;font-size:17px;border:none;font-family:'Space Grotesk';}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0a0a;}
    .btn-gold:hover{box-shadow:0 4px 20px var(--gglow);}
    .btn-purple{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;}
    .btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border);}

    .option-btn{width:100%;padding:18px 22px;font-size:16px;text-align:left;line-height:1.6;background:var(--card);border:2px solid var(--border);border-radius:14px;color:var(--text);font-family:'DM Sans';transition:all 0.2s;margin-bottom:10px;}
    .option-btn:hover{border-color:var(--gborder);}
    .option-btn.selected{background:rgba(212,168,83,0.08);border-color:var(--gold);}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:16px;}
    .card-gold{background:rgba(212,168,83,0.04);border-color:var(--gborder);}
    .card-green{border-color:rgba(16,185,129,0.15);}

    .score-bar{margin-bottom:14px;}
    .score-bar .top{display:flex;justify-content:space-between;margin-bottom:4px;}
    .score-bar .top .label{font-size:15px;color:var(--text2);}
    .score-bar .top .val{font-size:15px;font-weight:700;font-family:'Space Grotesk';}
    .score-bar .track{height:6px;background:rgba(255,255,255,0.06);border-radius:3px;}
    .score-bar .fill{height:100%;border-radius:3px;transition:width 1s ease;}

    .avatar-sm{width:32px;height:32px;border-radius:50%;overflow:hidden;border:1.5px solid var(--gold);flex-shrink:0;}
    .avatar-sm img{width:100%;height:100%;object-fit:cover;object-position:center top;}
    .avatar-md{width:44px;height:44px;}
    .avatar-lg{width:80px;height:80px;border-width:2px;box-shadow:0 0 30px var(--gglow);}
    .avatar-xl{width:140px;height:140px;border-width:3px;box-shadow:0 0 60px var(--gglow);}

    .pill-bar{display:flex;gap:4px;margin-bottom:20px;}
    .pill{height:6px;border-radius:3px;flex:1;transition:all 0.3s;}

    .center{text-align:center;}
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sb-brand">
    <div class="avatar-sm" style="border-radius:10px;"><img src="/socrates.png" alt=""></div>
    <div><div class="t hd">PhiloSim</div><div class="s" id="sbTag">Approach your work like Socrates</div></div>
  </div>
  <div class="sb-lang">
    <button class="active" onclick="setLang('en')">EN</button>
    <button onclick="setLang('fr')">FR</button>
  </div>
  <div class="sb-nav" id="sideNav"></div>
  <div class="sb-foot">
    <a href="/dashboard">‚Üê Dashboard</a>
  </div>
</div>

<div class="main">
  <div class="journey-bar" id="journeyBar"></div>
  <div class="content"><div class="content-inner" id="page"></div></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lang = 'en', view = 'welcome', playerName = '';
let learnStep = 0, checkStep = 0, checkAnswers = [], checkDone = false, selCheck = null, showInsight = false;
let scenario = null, round = 0, selOpt = null, showFeedback = false, decisions = [], simDone = false;
let allReports = JSON.parse(localStorage.getItem('philosim_sessions') || '[]');
let viewReport = null;

// Pick up auth token from cookie (set by Google OAuth callback)
(function() {
  const match = document.cookie.match(/(?:^|;\s*)auth_token=([^;]*)/);
  if (match) {
    localStorage.setItem('auth_token', match[1]);
    document.cookie = 'auth_token=; Path=/; Max-Age=0'; // clear cookie
  }
})();

const token = localStorage.getItem('auth_token');
let userPlan = 'free';

// Load user plan from API
if (token) {
  fetch('/api/auth/me', { headers: {'Authorization': 'Bearer ' + token} })
    .then(r => r.ok ? r.json() : null)
    .then(data => { if (data?.user) { userPlan = data.user.plan || 'free'; playerName = playerName || (data.user.name || '').split(' ')[0]; } })
    .catch(() => {});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTENT DATA (abbreviated keys for space)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PILLARS = [
  {icon:'ü™û',t:{en:'Know Thyself',fr:'Connais-toi toi-m√™me'},q:{en:'The unexamined life is not worth living.',fr:'Une vie sans examen ne vaut pas la peine d\'√™tre v√©cue.'},
   ex:{en:'Before you can lead others, you must understand your own biases, motivations, and blind spots. Socrates spent his life questioning people who claimed expertise and found most had never examined what they believed.',fr:'Avant de diriger, vous devez comprendre vos propres pr√©jug√©s et angles morts. Socrate questionnait ceux qui se disaient experts et d√©couvrait qu\'ils n\'avaient jamais examin√© leurs croyances.'},
   work:{en:'When you feel strongly about a decision, pause: Am I choosing this because it\'s right, or to protect my ego?',fr:'Quand vous √™tes convaincu, demandez-vous : est-ce juste, ou est-ce que √ßa prot√®ge mon ego?'}},
  {icon:'‚ùì',t:{en:'Question Everything',fr:'Questionnez tout'},q:{en:'I know that I know nothing.',fr:'Je sais que je ne sais rien.'},
   ex:{en:'The Socratic Method is dialogue through probing questions, not answers. By questioning assumptions, you expose contradictions and reach deeper truths.',fr:'La m√©thode socratique est un dialogue par questions incisives. En questionnant les hypoth√®ses, on expose les contradictions.'},
   work:{en:'Instead of "This strategy will work," ask: "What assumptions are we making? What would have to be true for this to fail?"',fr:'Au lieu de "√áa va marcher," demandez : "Quelles hypoth√®ses faisons-nous?"'}},
  {icon:'‚öñÔ∏è',t:{en:'Virtue is Knowledge',fr:'La vertu est connaissance'},q:{en:'No one does wrong willingly.',fr:'Nul ne fait le mal volontairement.'},
   ex:{en:'Socrates believed if you truly understand what is good, you will do it. Bad decisions come from ignorance, not malice.',fr:'Socrate croyait que si vous comprenez le bien, vous le ferez. Les mauvaises d√©cisions viennent de l\'ignorance.'},
   work:{en:'When someone makes a mistake, ask: What did they believe was true? What info were they missing?',fr:'Quand quelqu\'un fait une erreur, demandez : Que croyaient-ils? Quelle info leur manquait?'}},
  {icon:'üó£Ô∏è',t:{en:'Dialectical Reasoning',fr:'Le raisonnement dialectique'},q:{en:'The highest form of excellence is to question oneself and others.',fr:'La plus haute forme d\'excellence est de se questionner soi-m√™me et les autres.'},
   ex:{en:'Truth emerges through dialogue, not monologue. When two people genuinely explore a disagreement, both end up wiser.',fr:'La v√©rit√© √©merge du dialogue. Quand deux personnes explorent un d√©saccord, les deux deviennent plus sages.'},
   work:{en:'Instead of defending your position, ask: "Help me understand your perspective ‚Äî what am I missing?"',fr:'Au lieu de d√©fendre votre position, demandez : "Aidez-moi √† comprendre ‚Äî qu\'est-ce que je ne vois pas?"'}},
  {icon:'üèõÔ∏è',t:{en:'Epistemic Humility',fr:'L\'humilit√© √©pist√©mique'},q:{en:'Wisdom begins in wonder.',fr:'La sagesse commence dans l\'√©merveillement.'},
   ex:{en:'The Oracle called Socrates the wisest because he knew the limits of his knowledge. The most dangerous leader is the one who is certain.',fr:'L\'Oracle a d√©clar√© Socrate le plus sage parce qu\'il connaissait les limites de ses connaissances. Le leader le plus dangereux est celui qui est certain.'},
   work:{en:'Before a major decision, list what you DON\'T know. Then ask: who knows what I don\'t?',fr:'Avant une d√©cision majeure, listez ce que vous NE SAVEZ PAS.'}},
];

const CHECKS = {
  en:[
    {q:'A CEO says: "I\'ve been in this industry 30 years. I know exactly what will happen." What would Socrates say?',pillar:'Epistemic Humility',opts:[{t:'Trust his experience.',s:1},{t:'Certainty is dangerous. 30 years could mean 30 years of unchallenged assumptions.',s:3},{t:'He should validate with market research.',s:2}],insight:'Socrates would question the certainty itself.'},
    {q:'Your team is split 50/50 on strategy. You\'re the tiebreaker. Socratic approach?',pillar:'Dialectical Reasoning',opts:[{t:'Go with your gut.',s:1},{t:'Ask each side: "What would have to be true for the other side to be right?"',s:3},{t:'Bring in a consultant.',s:2}],insight:'Truth often lives between opposing positions.'},
    {q:'An employee makes a costly mistake. Socratic leader does what first?',pillar:'Virtue is Knowledge',opts:[{t:'Document the error and issue a warning.',s:1},{t:'Ask: "Walk me through your thinking when you made this decision."',s:3},{t:'Review the process to prevent future errors.',s:2}],insight:'No one does wrong willingly. Explore their reasoning.'},
    {q:'A deal benefits your company but harms a smaller partner. Socrates\' question?',pillar:'Know Thyself',opts:[{t:'"Will this maximize shareholder value?"',s:1},{t:'"If you were the partner being harmed, would you still call this just?"',s:3},{t:'"Have you consulted all stakeholders?"',s:2}],insight:'Socrates forces you to examine from the other\'s perspective.'},
  ],
  fr:[
    {q:'Un PDG dit : "30 ans d\'exp√©rience. Je sais ce qui va se passer." Socrate dirait?',pillar:'Humilit√© √©pist√©mique',opts:[{t:'Faire confiance √† son exp√©rience.',s:1},{t:'La certitude est dangereuse. 30 ans d\'hypoth√®ses non questionn√©es.',s:3},{t:'Valider avec plus de recherche.',s:2}],insight:'Socrate questionnerait la certitude elle-m√™me.'},
    {q:'√âquipe divis√©e 50/50. Vous tranchez. Approche socratique?',pillar:'Raisonnement dialectique',opts:[{t:'Suivre votre instinct.',s:1},{t:'Demander : "Que faudrait-il pour que l\'autre ait raison?"',s:3},{t:'Consultant externe.',s:2}],insight:'La v√©rit√© vit entre les positions oppos√©es.'},
    {q:'Erreur co√ªteuse d\'un employ√©. Leader socratique fait quoi?',pillar:'Vertu = connaissance',opts:[{t:'Documenter et avertir.',s:1},{t:'Demander : "Guidez-moi √† travers votre raisonnement."',s:3},{t:'Revoir le processus.',s:2}],insight:'Nul ne fait le mal volontairement.'},
    {q:'Accord profitable mais nuisible au partenaire. Question de Socrate?',pillar:'Connais-toi toi-m√™me',opts:[{t:'"Valeur actionnariale?"',s:1},{t:'"Si vous √©tiez le partenaire l√©s√©, appelleriez-vous cela juste?"',s:3},{t:'"Toutes les parties consult√©es?"',s:2}],insight:'Examiner du point de vue de l\'autre.'},
  ]
};

// SCENARIOS ‚Äî only including one full scenario to save space, second is identical structure
const SCENARIOS = [{
  id:'ethical_dilemma',icon:'‚öñÔ∏è',t:{en:'The Ethical Dilemma',fr:'Le Dilemme √âthique'},
  sub:{en:'Ship a buggy product or delay and face consequences?',fr:'Livrer un produit d√©faillant ou retarder?'},
  cat:'Ethics',dur:'10-15 min',skills:{en:['Ethical reasoning','Questioning assumptions','Virtue vs. profit'],fr:['Raisonnement √©thique','Questionner les hypoth√®ses','Vertu vs. profit']},
  sit:{en:'You\'re a Product Director. The CEO wants you to ship a product with unresolved bugs to meet quarterly targets. Sales promised delivery to 3 clients. Engineering needs 3 more weeks. Board meeting in 5 days.',fr:'Vous √™tes Directeur Produit. Le PDG veut livrer un produit avec bugs. Les ventes ont promis √† 3 clients. L\'ing√©nierie dit 3 semaines. R√©union du CA dans 5 jours.'},
  rounds:{
    en:[
      {ctx:'The CEO calls you: "Ship by Friday. The board is watching."',ask:'Before you answer ‚Äî what do you actually know about these bugs?',pillar:'Know Thyself',opts:[
        {t:'Ship it. Bugs are minor, patch later. Business first.',v:30,r:40,s:25,e:30,reply:'You say "minor" with confidence. But have you asked engineers what "minor" means to daily users?'},
        {t:'I need to understand the full scope first. Let me talk to engineering.',v:70,r:80,s:75,e:85,reply:'You resist pressure to decide before understanding. This is the beginning of wisdom.'},
        {t:'Tell the CEO we need 3 weeks. Quality is non-negotiable.',v:75,r:50,s:55,e:40,reply:'Noble! But you declared without examining. Could some bugs be fixed in 5 days? Certainty without examination is rigidity.'}]},
      {ctx:'Engineering says: 8 of 12 bugs are cosmetic. But 4 affect data accuracy in financial reports ‚Äî the core feature.',ask:'Four bugs corrupt what clients are paying for. What does this knowledge demand?',pillar:'Virtue is Knowledge',opts:[
        {t:'Ship with cosmetic bugs, fix the 4 critical ones first ‚Äî even if it takes an extra week.',v:85,r:90,s:80,e:75,reply:'You separate essential from superficial. Excellent. But how will you explain the delay to the CEO?'},
        {t:'Ship everything. Add a "known issues" disclaimer.',v:20,r:35,s:30,e:25,reply:'A disclaimer documents your awareness of the harm. It does not transform it into virtue.'},
        {t:'Delay the full 3 weeks to fix everything perfectly.',v:65,r:45,s:50,e:40,reply:'Is absolute perfection virtuous if it destroys the company that employs 200 people?'}]},
      {ctx:'CEO pushes back: "Sales VP already promised Friday delivery."',ask:'When promises and truth collide, which do you serve?',pillar:'Dialectical Reasoning',opts:[
        {t:'Let me talk to clients directly with a realistic timeline and guaranteed quality.',v:90,r:85,s:80,e:80,reply:'You propose dialogue over deception. You treat clients as rational beings who deserve truth.'},
        {t:'Sales VP made the promise. His problem to manage expectations.',v:35,r:40,s:25,e:35,reply:'If the product fails, will clients blame the Sales VP or the Product Director whose name is on the release?'},
        {t:'Ship a limited version without financial reporting, deliver the rest in 2 weeks.',v:75,r:90,s:70,e:75,reply:'A creative synthesis! Holding tension between opposing demands until a third option emerges. Dialectical reasoning at work.'}]},
      {ctx:'Sales VP sends angry email to leadership calling you "risk-averse and damaging to revenue."',ask:'You are attacked publicly. Does anger change what is true?',pillar:'Epistemic Humility',opts:[
        {t:'Reply-all with data: bug list, risk analysis, client impact.',v:60,r:70,s:50,e:55,reply:'You defend with evidence ‚Äî but a public battle may win the argument and lose the relationship.'},
        {t:'Request a private meeting. Understand what pressure he\'s under.',v:85,r:80,s:90,e:85,reply:'When attacked, you seek to understand rather than retaliate. This is wisdom in action.'},
        {t:'Ignore the email. My work will speak for itself.',v:55,r:50,s:45,e:40,reply:'Silence can be dignity or avoidance. You miss an opportunity to understand.'}]},
      {ctx:'Product ships 1 week late, all critical bugs fixed. 2 of 3 clients satisfied. Third left. CEO asks: "Was it worth it?"',ask:'You lost something real. How do you answer someone who measures wisdom in revenue?',pillar:'Know Thyself',opts:[
        {t:'We saved two clients who now trust our quality. The one we lost would have left after finding data bugs.',v:85,r:90,s:85,e:80,reply:'You reframe loss as investment in truth. You examined your decision without claiming perfection.'},
        {t:'Honestly? I\'m not sure. We made the best decision with what we knew. I\'d examine what to do differently.',v:70,r:75,s:90,e:95,reply:'The most Socratic answer ‚Äî "I\'m not sure." You resist claiming certainty even about your own wisdom.'},
        {t:'In hindsight, we should have shipped partial functionality faster.',v:55,r:65,s:60,e:65,reply:'You examine your decision and find it wanting. But don\'t confuse outcomes with wisdom.'}]},
    ],
    fr:[
      {ctx:'Le PDG vous appelle : "Livrer vendredi. Le CA nous observe."',ask:'Que savez-vous r√©ellement de ces bugs?',pillar:'Connais-toi toi-m√™me',opts:[
        {t:'Livrer. Les bugs sont mineurs, on corrige apr√®s.',v:30,r:40,s:25,e:30,reply:'Vous dites "mineurs" avec assurance. Avez-vous demand√© aux ing√©nieurs?'},
        {t:'Je dois comprendre la situation. Laissez-moi parler √† l\'ing√©nierie.',v:70,r:80,s:75,e:85,reply:'Vous r√©sistez √† la pression. C\'est le d√©but de la sagesse.'},
        {t:'On a besoin de 3 semaines. La qualit√© n\'est pas n√©gociable.',v:75,r:50,s:55,e:40,reply:'Noble! Mais certitude sans examen est rigidit√©.'}]},
      {ctx:'L\'ing√©nierie dit : 8 bugs cosm√©tiques, 4 affectent les rapports financiers.',ask:'Que cette connaissance exige-t-elle de vous?',pillar:'Vertu = connaissance',opts:[
        {t:'Livrer avec les cosm√©tiques, corriger les 4 critiques ‚Äî m√™me si √ßa prend une semaine.',v:85,r:90,s:80,e:75,reply:'Vous s√©parez l\'essentiel du superficiel.'},
        {t:'Tout livrer. Ajouter une note "probl√®mes connus."',v:20,r:35,s:30,e:25,reply:'Un avertissement documente votre conscience du mal. Il ne le transforme pas en vertu.'},
        {t:'Retarder 3 semaines pour tout corriger.',v:65,r:45,s:50,e:40,reply:'La perfection est-elle vertueuse si elle d√©truit l\'entreprise?'}]},
      {ctx:'Le PDG r√©siste : "Le VP Ventes a promis vendredi."',ask:'Quand promesses et v√©rit√© s\'affrontent, laquelle servez-vous?',pillar:'Raisonnement dialectique',opts:[
        {t:'Parler aux clients directement avec un calendrier r√©aliste.',v:90,r:85,s:80,e:80,reply:'Vous proposez le dialogue plut√¥t que la tromperie.'},
        {t:'Le VP a fait la promesse. C\'est √† lui de g√©rer.',v:35,r:40,s:25,e:35,reply:'Si le produit √©choue, qui sera bl√¢m√©?'},
        {t:'Version limit√©e sans rapports financiers, compl√©ter dans 2 semaines.',v:75,r:90,s:70,e:75,reply:'Synth√®se cr√©ative! Raisonnement dialectique en action.'}]},
      {ctx:'Le VP envoie un courriel furieux vous qualifiant de "frileux."',ask:'Sa col√®re change-t-elle ce qui est vrai?',pillar:'Humilit√© √©pist√©mique',opts:[
        {t:'R√©pondre √† tous avec des donn√©es.',v:60,r:70,s:50,e:55,reply:'Vous d√©fendez avec des preuves. Mais une bataille publique...'},
        {t:'R√©union priv√©e. Comprendre sa pression.',v:85,r:80,s:90,e:85,reply:'Quand on vous attaque, vous cherchez √† comprendre. Sagesse en action.'},
        {t:'Ignorer. Mon travail parlera.',v:55,r:50,s:45,e:40,reply:'Le silence peut √™tre dignit√© ou √©vitement.'}]},
      {ctx:'Produit livr√© 1 semaine en retard. 2/3 clients satisfaits. Le PDG : "√áa en valait la peine?"',ask:'Comment r√©pondez-vous √† un homme qui mesure la sagesse en revenus?',pillar:'Connais-toi toi-m√™me',opts:[
        {t:'On a sauv√© deux clients. Celui perdu serait parti en trouvant les bugs.',v:85,r:90,s:85,e:80,reply:'Vous recadrez la perte comme investissement dans la v√©rit√©.'},
        {t:'Honn√™tement? Je ne suis pas s√ªr. On a fait de notre mieux avec ce qu\'on savait.',v:70,r:75,s:90,e:95,reply:'La r√©ponse la plus socratique ‚Äî "Je ne suis pas s√ªr."'},
        {t:'Avec le recul, on aurait d√ª livrer une version partielle plus vite.',v:55,r:65,s:60,e:65,reply:'Ne confondez pas r√©sultats et sagesse.'}]},
    ]
  }
},{
  id:'leadership_conflict',icon:'üèõÔ∏è',t:{en:'The Leadership Question',fr:'La Question du Leadership'},
  sub:{en:'Promote your friend or the top performer? Justice meets loyalty.',fr:'Promouvoir votre ami ou le meilleur performeur?'},
  cat:'Justice',dur:'10-15 min',skills:{en:['Justice & fairness','Self-examination','Bias awareness'],fr:['Justice & √©quit√©','Auto-examen','Conscience des biais']},
  sit:{en:'You manage 25 people. A Senior Director role opens. Alex, your friend of 8 years, is solid. Jordan, joined 2 years ago, saved $2M. Both qualify. Your recommendation is decisive.',fr:'Vous g√©rez 25 personnes. Un poste de Directeur s\'ouvre. Alex, ami de 8 ans, est solide. Jordan, arriv√© il y a 2 ans, a √©conomis√© 2M$.'},
  rounds:{
    en:[
      {ctx:'HR asks for your recommendation. You catch yourself thinking "Alex deserves it."',ask:'You said "deserves." On what basis? Is tenure the same as merit?',pillar:'Know Thyself',opts:[
        {t:'I need to separate personal feelings from data. Let me review records objectively.',v:80,r:85,s:90,e:80,reply:'You recognize the bias. This is the hardest form of self-knowledge.'},
        {t:'Alex has paid his dues. Loyalty and consistency matter.',v:45,r:40,s:25,e:30,reply:'You may be confusing patience with excellence, and loyalty with justice.'},
        {t:'Jordan\'s results speak for themselves. $2M saved.',v:60,r:70,s:50,e:55,reply:'Compelling ‚Äî but are you overcorrecting to prove you\'re not biased?'}]},
      {ctx:'Records: Alex has steady "Meets Expectations." Jordan has two "Exceeds" but one failed project and team friction.',ask:'Alex is safe. Jordan is brilliant but imperfect. What does justice look like here?',pillar:'Dialectical Reasoning',opts:[
        {t:'Interview both: "What\'s your vision for this role?"',v:80,r:90,s:75,e:85,reply:'You let them reveal themselves through dialogue ‚Äî the Socratic way.'},
        {t:'Ask their direct reports for confidential feedback.',v:75,r:80,s:70,e:80,reply:'Wise ‚Äî but will Alex\'s fans and Jordan\'s critics give you truth or comfort?'},
        {t:'Data is clear. Jordan has superior results. Recommend Jordan.',v:55,r:60,s:40,e:35,reply:'Records capture what happened, not why. Are you comparing fairly?'}]},
      {ctx:'Alex: "I\'d maintain what works." Jordan: "I\'d restructure underperforming units."',ask:'Stability vs transformation. Which does the team NEED? And how do you separate need from preference?',pillar:'Epistemic Humility',opts:[
        {t:'Check the data: is the team underperforming? Let context decide.',v:75,r:85,s:70,e:80,reply:'You let the situation dictate the answer rather than your preference.'},
        {t:'I don\'t know. Let me consult VP and HR for perspectives I\'m missing.',v:70,r:70,s:85,e:95,reply:'The most courageous answer. You resist pressure to be all-knowing.'},
        {t:'Jordan\'s approach will cause disruption but growth. Comfort breeds complacency.',v:60,r:65,s:45,e:40,reply:'Notice your certainty. Is "comfort breeds complacency" always true?'}]},
      {ctx:'Alex comes to you: "I thought our friendship meant something. You\'d choose a newcomer?"',ask:'Friendship stands before you, wounded. Does love have a place in justice?',pillar:'Virtue is Knowledge',opts:[
        {t:'"Alex, our friendship is why I must be MORE careful, not less. I owe you fairness, not favoritism."',v:90,r:85,s:90,e:80,reply:'The most painful truth spoken with love. You honor friendship by refusing to corrupt it.'},
        {t:'"Nothing is decided yet. You\'re absolutely still in the running."',v:40,r:45,s:35,e:40,reply:'Kind ‚Äî but if you\'ve leaned toward Jordan, this is deception dressed as comfort.'},
        {t:'"This decision is about the role, not our relationship. But I value you regardless."',v:75,r:75,s:75,e:70,reply:'Truthful and compassionate. But will guilt still pull you toward Alex?'}]},
      {ctx:'Decision day. Everything points to Jordan. Your gut says Alex. You KNOW friendship is influencing you.',ask:'You know what is just and what is comfortable. What do you choose?',pillar:'Know Thyself',opts:[
        {t:'Recommend Jordan. I examined my bias, data supports it, justice demands the best person.',v:85,r:85,s:85,e:80,reply:'You choose justice over comfort. The process was wise ‚Äî you examined, sought perspectives, held the tension.'},
        {t:'Recommend Alex. Trust and cohesion matter more. I\'ve genuinely evaluated both.',v:50,r:55,s:35,e:30,reply:'You know your bias and deny it in the same breath. The examined life abandoned at the final moment.'},
        {t:'Present both to HR with honest assessments. Remove myself ‚Äî I can\'t be objective.',v:70,r:70,s:90,e:85,reply:'You recognize the limits of your objectivity. The rarest form of self-knowledge.'}]},
    ],
    fr:[
      {ctx:'Les RH demandent votre recommandation. Vous pensez "Alex le m√©rite."',ask:'Sur quelle base? L\'anciennet√© est-elle le m√©rite?',pillar:'Connais-toi toi-m√™me',opts:[
        {t:'S√©parer sentiments et donn√©es. Examiner objectivement.',v:80,r:85,s:90,e:80,reply:'Vous reconnaissez le biais. Forme la plus difficile de connaissance de soi.'},
        {t:'Alex a fait ses preuves dans le temps.',v:45,r:40,s:25,e:30,reply:'Confondez-vous patience et excellence?'},
        {t:'Les r√©sultats de Jordan parlent. 2M$ d\'√©conomies.',v:60,r:70,s:50,e:55,reply:'Sur-corrigez-vous pour prouver votre impartialit√©?'}]},
      {ctx:'Dossiers : Alex "Satisfait" constant. Jordan deux "D√©passe" mais un √©chec et des frictions.',ask:'√Ä quoi ressemble la justice quand les deux voies ont du m√©rite?',pillar:'Raisonnement dialectique',opts:[
        {t:'Entretiens s√©par√©s : "Votre vision pour ce poste?"',v:80,r:90,s:75,e:85,reply:'Vous les laissez se r√©v√©ler par le dialogue.'},
        {t:'Retour confidentiel des √©quipes.',v:75,r:80,s:70,e:80,reply:'Sage ‚Äî mais les fans d\'Alex et les critiques de Jordan donneront-ils la v√©rit√©?'},
        {t:'Donn√©es claires. Recommander Jordan.',v:55,r:60,s:40,e:35,reply:'Les dossiers capturent quoi, pas pourquoi.'}]},
      {ctx:'Alex : "Maintenir ce qui fonctionne." Jordan : "Restructurer."',ask:'De quoi l\'√©quipe a-t-elle BESOIN?',pillar:'Humilit√© √©pist√©mique',opts:[
        {t:'Consulter les donn√©es de performance.',v:75,r:85,s:70,e:80,reply:'Vous laissez la situation dicter.'},
        {t:'Je ne sais pas. Consulter VP et RH.',v:70,r:70,s:85,e:95,reply:'R√©ponse la plus courageuse.'},
        {t:'Jordan causera des remous mais de la croissance.',v:60,r:65,s:45,e:40,reply:'Remarquez votre certitude.'}]},
      {ctx:'Alex : "Je pensais que notre amiti√© comptait."',ask:'L\'amiti√© a-t-elle sa place dans la justice?',pillar:'Vertu = connaissance',opts:[
        {t:'"Notre amiti√© est la raison d\'√™tre PLUS prudent, pas moins."',v:90,r:85,s:90,e:80,reply:'V√©rit√© douloureuse dite avec amour.'},
        {t:'"Rien n\'est d√©cid√©. Tu es encore dans la course."',v:40,r:45,s:35,e:40,reply:'Tromperie d√©guis√©e en r√©confort.'},
        {t:'"La d√©cision est bas√©e sur le poste, pas la relation."',v:75,r:75,s:75,e:70,reply:'Vrai et compatissant.'}]},
      {ctx:'Jour de d√©cision. Tout pointe vers Jordan. Votre instinct dit Alex.',ask:'Que choisissez-vous?',pillar:'Connais-toi toi-m√™me',opts:[
        {t:'Recommander Jordan. Biais examin√©, donn√©es confirment.',v:85,r:85,s:85,e:80,reply:'Justice plut√¥t que confort. Le processus √©tait sage.'},
        {t:'Recommander Alex. Constance et confiance comptent.',v:50,r:55,s:35,e:30,reply:'Vie examin√©e abandonn√©e au dernier moment.'},
        {t:'Pr√©senter les deux aux RH. Me retirer.',v:70,r:70,s:90,e:85,reply:'Forme la plus rare de connaissance de soi.'}]},
    ]
  }
}];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const T = {
  en:{brand:'PhiloSim',tag:'Approach your work like Socrates',p1:'Phase 1',p2:'Phase 2',p3:'Phase 3',p1t:'The Philosophy',p2t:'Do You Get It?',p3t:'Apply Under Pressure',enterName:'Enter your name...',start:'Start',watch:'Watch: Who Was Socrates?',watchNote:'Understand the man, his method, and why his ideas still matter.',explore5:'Explore the 5 Pillars ‚Üí',pillar:'Pillar',of:'of',thePhil:'The Philosophy',atWork:'At Work',prev:'‚Üê Previous',next:'Next ‚Üí',readyCheck:'Test My Understanding ‚Üí',confirm:'Confirm',seeResults:'See Results ‚Üí',yourScore:'Your Socratic Readiness',enterSim:'Enter the Simulation ‚Üí',scoreHigh:'Excellent! Now apply it under pressure.',scoreMid:'Good foundation. The simulation will reveal the gap.',scoreLow:'You think conventionally. Let Socrates push you.',selectScenario:'Choose Your Challenge',decision:'Decision',makeChoice:'Make your choice',socratesInsight:'Socrates\' Insight',nextDecision:'Next Decision ‚Üí',viewReport:'View Report ‚Üí',backToScenarios:'‚Üê New Scenario',sessionWith:'Session with Socrates',virtue:'Virtue & Ethics',reasoning:'Reasoning',selfAware:'Self-Awareness',epistemic:'Epistemic Humility',overallScore:'Overall Wisdom Score',strengths:'Strengths',growth:'Growth Areas',closingQ:'Question to Ponder',yourDecisions:'Your Decisions',socraticAnswer:'Socratic answer:',noReports:'No sessions yet.',video:'‚Üê Video',report:'Report',history:'History',welcome:'Welcome'},
  fr:{brand:'PhiloSim',tag:'Abordez votre travail comme Socrate',p1:'Phase 1',p2:'Phase 2',p3:'Phase 3',p1t:'La Philosophie',p2t:'Compris?',p3t:'Appliquer',enterName:'Votre nom...',start:'Commencer',watch:'Regarder : Qui √©tait Socrate?',watchNote:'Comprenez l\'homme et sa m√©thode.',explore5:'Explorer les 5 Piliers ‚Üí',pillar:'Pilier',of:'de',thePhil:'La Philosophie',atWork:'Au travail',prev:'‚Üê Pr√©c√©dent',next:'Suivant ‚Üí',readyCheck:'Testez-moi ‚Üí',confirm:'Confirmer',seeResults:'R√©sultats ‚Üí',yourScore:'Pr√©paration Socratique',enterSim:'Entrer dans la Simulation ‚Üí',scoreHigh:'Excellent! Voyons sous pression.',scoreMid:'Bonne base. La simulation r√©v√©lera l\'√©cart.',scoreLow:'Vous pensez conventionnellement.',selectScenario:'Choisissez Votre D√©fi',decision:'D√©cision',makeChoice:'Faites votre choix',socratesInsight:'√âclairage de Socrate',nextDecision:'D√©cision suivante ‚Üí',viewReport:'Voir le Rapport ‚Üí',backToScenarios:'‚Üê Nouveau Sc√©nario',sessionWith:'Session avec Socrate',virtue:'Vertu & √âthique',reasoning:'Raisonnement',selfAware:'Conscience de Soi',epistemic:'Humilit√© √âpist√©mique',overallScore:'Score de Sagesse',strengths:'Forces',growth:'Croissance',closingQ:'Question √† M√©diter',yourDecisions:'Vos D√©cisions',socraticAnswer:'R√©ponse socratique:',noReports:'Aucune session.',video:'‚Üê Vid√©o',report:'Rapport',history:'Historique',welcome:'Bienvenue'}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function t(k) { return T[lang][k] || k; }

function setLang(l) {
  lang = l;
  document.querySelectorAll('.sb-lang button').forEach(b => b.classList.toggle('active', b.textContent.trim() === l.toUpperCase()));
  document.getElementById('sbTag').textContent = t('tag');
  render();
}

function go(v) { view = v; render(); }

function render() {
  renderNav();
  renderJourney();
  renderPage();
}

function renderNav() {
  const items = [
    {id:'welcome',icon:'üè†',label:t('welcome')},
    {id:'learn',icon:'üìñ',label:t('p1t'),badge:t('p1')},
    {id:'check',icon:'üß†',label:t('p2t'),badge:t('p2')},
    {id:'scenarios',icon:'‚ö°',label:t('p3t'),badge:t('p3')},
  ];
  if (view === 'play' && !simDone) items.push({id:'play',icon:'üéØ',label:`${t('decision')} ${round+1}/5`});
  items.push({id:'report',icon:'üìú',label:t('report')});
  items.push({id:'history',icon:'üìö',label:t('history')});

  document.getElementById('sideNav').innerHTML = items.map(i =>
    `<button class="${view===i.id?'active':''}" onclick="go('${i.id}')">
      <span class="icon">${i.icon}</span><span>${i.label}</span>
      ${i.badge ? `<span class="badge">${i.badge}</span>` : ''}
    </button>`
  ).join('');
}

function renderJourney() {
  const idx = view==='learn'?0:view==='check'?1:(view==='scenarios'||view==='play')?2:-1;
  if (idx < 0) { document.getElementById('journeyBar').style.display = 'none'; return; }
  document.getElementById('journeyBar').style.display = 'flex';
  const steps = [{id:'learn',l:t('p1'),t:t('p1t'),i:'üìñ'},{id:'check',l:t('p2'),t:t('p2t'),i:'üß†'},{id:'scenarios',l:t('p3'),t:t('p3t'),i:'‚ö°'}];
  document.getElementById('journeyBar').innerHTML = steps.map((s,i) => {
    const cls = i<idx?'done':i===idx?'active':'future';
    return `<div class="jb-step" onclick="go('${s.id}')">
      <div class="dot ${cls}">${i<idx?'‚úì':s.i}</div>
      <div class="info"><div class="label" style="color:${i===idx?'var(--gold)':'var(--muted)'}">${s.l}</div><div class="title" style="color:${i===idx?'var(--text)':'var(--muted)'}">${s.t}</div></div>
    </div>${i<2?`<div class="jb-line" style="background:${i<idx?'rgba(16,185,129,0.3)':'var(--border)'}"></div>`:''}`;
  }).join('');
}

function renderPage() {
  const pg = document.getElementById('page');
  pg.innerHTML = '';
  if (view === 'welcome') renderWelcome(pg);
  else if (view === 'learn') renderLearn(pg);
  else if (view === 'check') renderCheck(pg);
  else if (view === 'scenarios') renderScenarios(pg);
  else if (view === 'play') renderPlay(pg);
  else if (view === 'report') renderReportView(pg);
  else if (view === 'history') renderHistory(pg);
}

// ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê
function renderWelcome(pg) {
  pg.innerHTML = `<div class="center fade" style="padding-top:40px;">
    <div class="avatar-xl" style="margin:0 auto 24px;border-radius:50%;"><img src="/socrates.png" alt=""></div>
    <h1 class="hd" style="font-size:48px;margin-bottom:8px;">${t('brand')}</h1>
    <div style="font-size:19px;color:var(--gold);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:28px;">${t('tag')}</div>
    ${!playerName ? `<div style="display:flex;gap:8px;max-width:400px;margin:0 auto;">
      <input id="nameIn" placeholder="${t('enterName')}" style="flex:1;padding:14px 20px;font-size:17px;background:var(--bg2);color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none;font-family:'DM Sans';" onkeydown="if(event.key==='Enter')startJourney()">
      <button class="btn btn-gold" onclick="startJourney()">${t('start')}</button>
    </div>` : `<button class="btn btn-gold" onclick="go('learn')">${t('start')}</button>`}
  </div>`;
}

function startJourney() {
  const n = document.getElementById('nameIn')?.value.trim();
  if (!n) return;
  playerName = n;
  go('learn');
}

function renderLearn(pg) {
  if (learnStep === 0) {
    pg.innerHTML = `<div class="fade"><h2 class="hd" style="font-size:32px;margin-bottom:6px;">${t('watch')}</h2>
    <p style="color:var(--text2);font-size:17px;margin-bottom:20px;">${t('watchNote')}</p>
    <div style="position:relative;padding-bottom:56.25%;border-radius:16px;overflow:hidden;border:1px solid var(--border);margin-bottom:24px;">
      <iframe src="https://www.youtube.com/embed/6DGnwLTnoPY" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe>
    </div>
    <div class="center"><button class="btn btn-gold" onclick="learnStep=1;render()">${t('explore5')}</button></div></div>`;
  } else {
    const p = PILLARS[learnStep-1];
    pg.innerHTML = `<div class="fade">
    <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
      <span style="color:var(--muted);font-weight:600;">${t('pillar')} ${learnStep} ${t('of')} 5</span>
      <div class="pill-bar" style="width:200px;">${[1,2,3,4,5].map(i=>`<div class="pill" style="background:${i===learnStep?'var(--gold)':i<learnStep?'var(--green)':'rgba(255,255,255,0.08)'};cursor:pointer;" onclick="learnStep=${i};render()"></div>`).join('')}</div>
    </div>
    <div class="card card-gold" style="padding:28px;">
      <div style="font-size:44px;margin-bottom:12px;">${p.icon}</div>
      <h2 class="hd" style="font-size:30px;margin-bottom:10px;">${p.t[lang]}</h2>
      <div style="font-size:20px;color:var(--gold);font-style:italic;">"${p.q[lang]}"</div>
    </div>
    <div class="card"><div style="font-size:13px;font-weight:700;color:var(--purple);text-transform:uppercase;margin-bottom:10px;">üìñ ${t('thePhil')}</div>
      <p style="font-size:17px;color:var(--text2);line-height:1.75;">${p.ex[lang]}</p></div>
    <div class="card card-green"><div style="font-size:13px;font-weight:700;color:var(--green);text-transform:uppercase;margin-bottom:10px;">üíº ${t('atWork')}</div>
      <p style="font-size:17px;color:var(--text);line-height:1.75;font-style:italic;">${p.work[lang]}</p></div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-outline" onclick="learnStep=${learnStep-1};render()">${learnStep===1?t('video'):t('prev')}</button>
      ${learnStep<5?`<button class="btn btn-gold" onclick="learnStep=${learnStep+1};render()">${t('next')}</button>`
      :`<button class="btn btn-purple" onclick="checkStep=0;checkAnswers=[];checkDone=false;selCheck=null;showInsight=false;go('check')">${t('readyCheck')}</button>`}
    </div></div>`;
  }
}

function renderCheck(pg) {
  const qs = CHECKS[lang];
  if (!checkDone) {
    const q = qs[checkStep];
    pg.innerHTML = `<div class="fade">
    <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
      <span style="color:var(--muted);">Q${checkStep+1}/${qs.length}</span>
      <div class="pill-bar" style="width:160px;">${qs.map((_,i)=>`<div class="pill" style="background:${i===checkStep?'var(--gold)':i<checkStep?'var(--green)':'rgba(255,255,255,0.08)'}"></div>`).join('')}</div>
    </div>
    <div class="card card-gold">
      <span style="font-size:13px;font-weight:700;color:var(--gold);padding:3px 10px;background:rgba(212,168,83,0.08);border-radius:6px;">${q.pillar}</span>
      <p class="hd" style="font-size:20px;font-weight:600;margin-top:12px;line-height:1.6;">${q.q}</p>
    </div>
    <div>${q.opts.map((o,i)=>`<button class="option-btn ${selCheck===i?'selected':''}" onclick="selCheck=${i};render()" ${showInsight?'disabled':''}>${o.t}${showInsight && o.s===3?'<span style="margin-left:8px;color:var(--green);font-size:13px;">‚úì Socratic</span>':''}</button>`).join('')}</div>
    ${!showInsight && selCheck!==null ? `<div class="center"><button class="btn btn-gold" onclick="checkAnswers.push(${CHECKS[lang][checkStep].opts[selCheck].s});showInsight=true;render()">${t('confirm')}</button></div>` : ''}
    ${showInsight ? `<div class="card card-gold fade"><div style="font-size:13px;font-weight:700;color:var(--gold);margin-bottom:10px;">üèõÔ∏è ${t('socratesInsight')}</div>
      <p style="font-size:16px;color:var(--text2);font-style:italic;">${q.insight}</p></div>
    <div class="center"><button class="btn btn-purple" onclick="selCheck=null;showInsight=false;${checkStep<qs.length-1?`checkStep++;render()`:`checkDone=true;render()`}">${checkStep<qs.length-1?t('next'):t('seeResults')}</button></div>` : ''}
    </div>`;
  } else {
    const total = checkAnswers.reduce((s,a)=>s+a,0);
    const pct = Math.round(total/(qs.length*3)*100);
    const color = pct>=75?'var(--green)':pct>=50?'var(--gold)':'var(--warn)';
    pg.innerHTML = `<div class="center fade" style="padding-top:20px;">
      <div class="avatar-lg" style="margin:0 auto 16px;border-radius:50%;"><img src="/socrates.png" alt=""></div>
      <h2 class="hd" style="font-size:30px;margin-bottom:8px;">${t('yourScore')}</h2>
      <div class="hd" style="font-size:56px;font-weight:700;color:${color};margin-bottom:24px;">${pct}%</div>
      <p style="font-size:18px;color:var(--text2);max-width:520px;margin:0 auto 32px;">${pct>=75?t('scoreHigh'):pct>=50?t('scoreMid'):t('scoreLow')}</p>
      <button class="btn btn-gold" style="box-shadow:0 4px 20px var(--gglow);" onclick="go('scenarios')">${t('enterSim')}</button>
    </div>`;
  }
}

function renderScenarios(pg) {
  pg.innerHTML = `<div class="fade">
    <div style="display:flex;align-items:center;gap:20px;margin-bottom:24px;">
      <div class="avatar-lg" style="border-radius:50%;"><img src="/socrates.png" alt=""></div>
      <div><h2 class="hd" style="font-size:34px;">${t('selectScenario')}</h2></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;">
    ${SCENARIOS.map((sc,idx)=>{
      const locked = idx > 0 && userPlan === 'free';
      return `<div onclick="${locked ? 'showUpgradePrompt()' : `startSim('${sc.id}')`}" style="background:var(--card);border:1px solid ${locked?'rgba(255,255,255,0.03)':'var(--border)'};border-radius:16px;padding:22px;cursor:pointer;transition:all 0.3s;${locked?'opacity:0.6;':''}position:relative;" onmouseover="this.style.borderColor='var(--gborder)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='${locked?'rgba(255,255,255,0.03)':'var(--border)'}';this.style.transform='none'">
      ${locked?`<div style="position:absolute;top:12px;right:12px;background:rgba(212,168,83,0.15);color:var(--gold);font-size:12px;font-weight:700;padding:4px 10px;border-radius:6px;border:1px solid var(--gborder);">üîí ${lang==='fr'?'Premium':'Premium'}</div>`:''}
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        <span style="font-size:30px">${sc.icon}</span>
        <div><div class="hd" style="font-weight:700;font-size:22px;">${sc.t[lang]}</div><div style="font-size:14px;color:var(--muted);">${sc.cat} ¬∑ ${sc.dur} ¬∑ 5 ${t('decision')}s</div></div>
      </div>
      <p style="font-size:16px;color:var(--text2);margin-bottom:12px;">${sc.sub[lang]}</p>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">${sc.skills[lang].map(s=>`<span style="font-size:13px;padding:4px 10px;border-radius:6px;background:rgba(212,168,83,0.07);color:var(--gold);border:1px solid var(--gborder);">${s}</span>`).join('')}</div>
    </div>`;}).join('')}
    </div></div>`;
}

function startSim(id) {
  scenario = SCENARIOS.find(s=>s.id===id);
  round=0; selOpt=null; showFeedback=false; decisions=[]; simDone=false;
  go('play');
}

function showUpgradePrompt() {
  const msg = lang === 'fr'
    ? 'Ce sc√©nario est r√©serv√© aux membres Thinker et Philosopher.\n\nPassez au plan Thinker ($19/mois) ou Philosopher ($149 √† vie) pour d√©bloquer tous les sc√©narios.'
    : 'This scenario is available for Thinker and Philosopher members.\n\nUpgrade to Thinker ($19/mo) or Philosopher ($149 lifetime) to unlock all scenarios.';
  if (confirm(msg + (lang==='fr' ? '\n\nVoir les plans ?' : '\n\nView plans?'))) {
    window.location.href = '/#pricing';
  }
}

function renderPlay(pg) {
  if (simDone && viewReport) { renderReportCard(pg, viewReport); pg.innerHTML += `<div class="center" style="margin-top:20px;padding-bottom:20px;"><button class="btn btn-gold" onclick="simDone=false;go('scenarios')">${t('backToScenarios')}</button></div>`; return; }
  const rd = scenario.rounds[lang][round];
  pg.innerHTML = `<div class="fade">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:24px">${scenario.icon}</span>
        <div><div class="hd" style="font-weight:700;font-size:18px;">${scenario.t[lang]}</div><div style="font-size:13px;color:var(--muted);">${t('decision')} ${round+1} ${t('of')} 5</div></div>
      </div>
      <div class="pill-bar" style="width:160px;">${scenario.rounds[lang].map((_,i)=>`<div class="pill" style="background:${i===round?'var(--gold)':i<round?'var(--green)':'rgba(255,255,255,0.08)'}"></div>`).join('')}</div>
    </div>
    <div class="card"><div style="font-size:13px;font-weight:700;color:var(--warn);text-transform:uppercase;margin-bottom:8px;">üìã Context</div>
      <p style="font-size:17px;line-height:1.65;">${rd.ctx}</p></div>
    <div style="display:flex;gap:12px;margin-bottom:20px;">
      <div class="avatar-sm avatar-md" style="border-radius:50%;"><img src="/socrates.png" alt=""></div>
      <div class="card card-gold" style="flex:1;border-radius:16px 16px 16px 4px;margin:0;">
        <div style="font-size:13px;font-weight:700;color:var(--gold);margin-bottom:6px;">Socrate${lang==='en'?'s':''} ¬∑ <span style="font-weight:400;color:var(--muted);">${rd.pillar}</span></div>
        <p style="font-size:17px;line-height:1.65;font-style:italic;">${rd.ask}</p>
      </div>
    </div>
    ${!showFeedback ? `<div style="font-size:14px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:10px;">üéØ ${t('makeChoice')}</div>
    ${rd.opts.map((o,i)=>`<button class="option-btn ${selOpt===i?'selected':''}" onclick="selOpt=${i};render()">${o.t}</button>`).join('')}
    ${selOpt!==null?`<div class="center"><button class="btn btn-gold" onclick="confirmChoice()">${t('confirm')}</button></div>`:''}` :
    `<div class="card card-gold fade">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div class="avatar-sm" style="border-radius:50%;margin-top:2px;"><img src="/socrates.png" alt=""></div>
        <div><div style="font-size:13px;font-weight:700;color:var(--gold);margin-bottom:6px;">üèõÔ∏è ${t('socratesInsight')}</div>
          <p style="font-size:16px;color:var(--text2);line-height:1.75;font-style:italic;">${decisions[decisions.length-1].reply}</p></div>
      </div>
    </div>
    <div class="center"><button class="btn btn-purple" onclick="nextRound()">${round<4?t('nextDecision'):t('viewReport')}</button></div>`}
  </div>`;
}

function confirmChoice() {
  if (selOpt===null) return;
  const rd = scenario.rounds[lang][round];
  const opt = rd.opts[selOpt];
  decisions.push({roundIdx:round,optIdx:selOpt,scores:{v:opt.v,r:opt.r,s:opt.s,e:opt.e},pillar:rd.pillar,reply:opt.reply,choice:opt.t});
  showFeedback = true; render();
}

function nextRound() {
  if (round < 4) { round++; selOpt=null; showFeedback=false; render(); }
  else { finishSim(); }
}

function finishSim() {
  const avg = k => Math.round(decisions.reduce((s,d)=>s+d.scores[k],0)/decisions.length);
  const scores = {v:avg('v'),r:avg('r'),s:avg('s'),e:avg('e')};
  const overall = Math.round((scores.v+scores.r+scores.s+scores.e)/4);
  const names = {v:t('virtue'),r:t('reasoning'),s:t('selfAware'),e:t('epistemic')};
  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const checkTotal = checkAnswers.reduce((s,a)=>s+a,0);
  const checkPct = Math.round(checkTotal/(CHECKS[lang].length*3)*100);

  const strongDecs = decisions.filter(d => (d.scores.v+d.scores.r+d.scores.s+d.scores.e)/4 >= 80);
  const weakDecs = decisions.filter(d => (d.scores.v+d.scores.r+d.scores.s+d.scores.e)/4 < 60);

  const report = {
    scenarioTitle: scenario.t[lang], scenarioId: scenario.id, date: new Date().toLocaleDateString(), playerName,
    decisions: decisions.length, checkScore: checkPct,
    virtue: scores.v, reasoning: scores.r, selfAware: scores.s, epistemic: scores.e, overall,
    strongest: names[sorted[0][0]], weakest: names[sorted[sorted.length-1][0]],
    strengthExplain: strongDecs.length>0 ? `${lang==='fr'?'D√©cisions':'Decisions'} ${strongDecs.map(d=>d.roundIdx+1).join(', ')}: ${strongDecs.map(d=>d.pillar).join(', ')}` : (lang==='fr'?'Aucune d√©cision au niveau socratique.':'No decisions reached Socratic level.'),
    weaknessExplain: weakDecs.length>0 ? `${lang==='fr'?'D√©cisions':'Decisions'} ${weakDecs.map(d=>d.roundIdx+1).join(', ')}: ${lang==='fr'?'D√©viation sur':'Deviated on'} ${weakDecs.map(d=>d.pillar).join(', ')}` : (lang==='fr'?'Pas de d√©viation majeure.':'No major deviations.'),
    verdict: overall>=80?(lang==='fr'?'Pens√©e socratique d√©montr√©e. Vous questionnez avant de juger.':'Genuinely Socratic thinking. You questioned before judging.'):overall>=60?(lang==='fr'?'Instincts prometteurs mais retour au conventionnel sous pression.':'Promising instincts but conventional thinking under pressure.'):lang==='fr'?'Confort plut√¥t qu\'examen.':'Comfort over examination.',
    closingQuestion: overall>=80?(lang==='fr'?'Questionnez-vous aussi vos victoires?':'Do you question your own victories?'):overall>=60?(lang==='fr'?'Quand avez-vous chang√© d\'avis honn√™tement?':'When did you last change your mind honestly?'):(lang==='fr'?'Pouvez-vous expliquer POURQUOI chaque choix?':'Can you explain WHY each choice?'),
    reviews: decisions.map((d,i) => {
      const rd = scenario.rounds[lang][d.roundIdx];
      const avgS = Math.round((d.scores.v+d.scores.r+d.scores.s+d.scores.e)/4);
      const best = rd.opts.reduce((b,o)=>{const s=(o.v+o.r+o.s+o.e)/4;return s>b.s?{s,t:o.t}:b;},{s:0,t:''});
      return {round:i+1,pillar:d.pillar,choice:d.choice,score:avgS,reply:d.reply,optimal:avgS>=80,bestChoice:avgS<70?best.t:null};
    })
  };
  allReports.unshift(report);
  localStorage.setItem('philosim_sessions', JSON.stringify(allReports));

  // Save to database if logged in
  if (token) {
    fetch('/api/sessions/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({
        scenarioId: report.scenarioId, scenarioTitle: report.scenarioTitle, language: lang,
        checkScore: report.checkScore, overall: report.overall,
        virtue: report.virtue, reasoning: report.reasoning,
        selfAware: report.selfAware, epistemic: report.epistemic,
        strongest: report.strongest, weakest: report.weakest,
        decisions: report.reviews
      })
    }).catch(e => console.warn('Session save to DB failed:', e));
  }

  viewReport = report; simDone = true; render();
}

function renderReportCard(pg, r) {
  const color = s => s>=80?'var(--green)':s>=60?'var(--gold)':'var(--warn)';
  pg.innerHTML = `<div class="fade">
    <div class="card card-gold center">
      <div class="avatar-lg" style="margin:0 auto 12px;border-radius:50%;"><img src="/socrates.png" alt=""></div>
      <div class="hd" style="font-size:24px;font-weight:700;">${t('sessionWith')}</div>
      <div style="color:var(--gold);font-size:16px;">${r.scenarioTitle}</div>
      <div style="color:var(--muted);font-size:14px;margin-top:4px;">${r.date} ¬∑ ${r.playerName} ¬∑ ${r.decisions} decisions</div>
    </div>
    <div class="card center" style="background:linear-gradient(135deg,rgba(212,168,83,0.04),rgba(99,102,241,0.04));border-color:var(--gborder);">
      <div class="hd" style="font-size:48px;font-weight:700;color:${color(r.overall)};">${r.overall}/100</div>
      <div style="font-size:14px;color:var(--muted);text-transform:uppercase;font-weight:700;">${t('overallScore')}</div>
    </div>
    <div class="card">
      ${scoreBar(t('virtue'),r.virtue,'var(--green)')}${scoreBar(t('reasoning'),r.reasoning,'var(--purple)')}${scoreBar(t('selfAware'),r.selfAware,'var(--purple2)')}${scoreBar(t('epistemic'),r.epistemic,'var(--gold)')}
    </div>
    <div class="card card-gold">
      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div class="avatar-sm" style="border-radius:50%;margin-top:2px;"><img src="/socrates.png" alt=""></div>
        <div><div class="hd" style="font-weight:700;color:var(--gold);margin-bottom:8px;">üèõÔ∏è ${lang==='fr'?'Verdict de Socrate':'Socrates\' Verdict'}</div>
          <p style="font-size:17px;line-height:1.7;font-style:italic;">${r.verdict}</p></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div class="card" style="border-color:rgba(16,185,129,0.15);"><div class="hd" style="font-weight:700;color:var(--green);margin-bottom:4px;">‚ú¶ ${t('strengths')}</div><div style="font-weight:600;margin-bottom:8px;">${r.strongest}</div><div style="font-size:14px;color:var(--text2);">${r.strengthExplain}</div></div>
      <div class="card" style="border-color:rgba(245,158,11,0.15);"><div class="hd" style="font-weight:700;color:var(--warn);margin-bottom:4px;">‚Üó ${t('growth')}</div><div style="font-weight:600;margin-bottom:8px;">${r.weakest}</div><div style="font-size:14px;color:var(--text2);">${r.weaknessExplain}</div></div>
    </div>
    ${r.reviews?`<div class="card"><div class="hd" style="font-weight:700;font-size:17px;margin-bottom:16px;">${t('yourDecisions')}</div>
    ${r.reviews.map((d,i)=>`<div style="margin-bottom:${i<r.reviews.length-1?'20':'0'}px;padding-bottom:${i<r.reviews.length-1?'20':'0'}px;border-bottom:${i<r.reviews.length-1?'1px solid var(--border)':'none'};">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;background:${d.optimal?'rgba(16,185,129,0.15)':d.score>=60?'rgba(212,168,83,0.15)':'rgba(245,158,11,0.15)'};color:${color(d.score)}">${d.round}</div>
          <span style="font-size:13px;font-weight:700;color:var(--gold);padding:2px 8px;background:rgba(212,168,83,0.08);border-radius:6px;">${d.pillar}</span>
        </div>
        <span class="hd" style="font-weight:700;color:${color(d.score)};">${d.score}/100</span>
      </div>
      <div style="font-size:14px;color:var(--muted);margin-bottom:6px;"><strong style="color:var(--text2);">${lang==='fr'?'Votre choix:':'Your choice:'}</strong> ${d.choice}</div>
      <div style="display:flex;gap:8px;align-items:flex-start;">
        <div class="avatar-sm" style="border-radius:50%;width:20px;height:20px;min-width:20px;margin-top:2px;"><img src="/socrates.png" alt=""></div>
        <p style="font-size:14px;color:var(--text2);font-style:italic;line-height:1.6;">${d.reply}</p>
      </div>
      ${d.bestChoice?`<div style="margin-top:8px;padding:8px 12px;background:rgba(16,185,129,0.05);border:1px solid rgba(16,185,129,0.15);border-radius:8px;font-size:13px;color:var(--green);">üí° ${t('socraticAnswer')} ${d.bestChoice}</div>`:''}
    </div>`).join('')}</div>`:''}
    <div class="card center" style="border-color:rgba(99,102,241,0.2);">
      <div class="hd" style="font-weight:700;color:var(--cyan);margin-bottom:10px;">‚ùì ${t('closingQ')}</div>
      <p style="font-size:16px;color:var(--text2);font-style:italic;">${r.closingQuestion}</p>
    </div>
  </div>`;
}

function renderReportView(pg) {
  if (allReports.length > 0) { renderReportCard(pg, allReports[0]); }
  else { pg.innerHTML = `<div class="card center"><p style="color:var(--text2);">${t('noReports')}</p></div>`; }
}

function renderHistory(pg) {
  pg.innerHTML = `<div class="fade"><h2 class="hd" style="font-size:30px;margin-bottom:24px;">üìö ${t('history')}</h2>
  ${allReports.length===0?`<div class="card center"><p style="color:var(--text2);">${t('noReports')}</p></div>`:
  allReports.map((r,i)=>{
    const c = r.overall>=80?'var(--green)':r.overall>=60?'var(--gold)':'var(--warn)';
    return `<div class="card" style="cursor:pointer;margin-bottom:12px;" onclick="viewReport=allReports[${i}];go('report')" onmouseover="this.style.borderColor='var(--gborder)'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><div class="hd" style="font-weight:700;font-size:17px;">${r.scenarioTitle}</div><div style="font-size:14px;color:var(--muted);">${r.date} ¬∑ ${r.decisions} decisions</div></div>
        <div class="hd" style="font-size:28px;font-weight:700;color:${c};">${r.overall}</div>
      </div></div>`;
  }).join('')}</div>`;
}

function scoreBar(label,score,color) {
  return `<div class="score-bar"><div class="top"><span class="label">${label}</span><span class="val" style="color:${color}">${score}/100</span></div><div class="track"><div class="fill" style="width:${score}%;background:${color};"></div></div></div>`;
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
async function init() {
  if (token) {
    try {
      const r = await fetch('/api/auth/me', { headers: {'Authorization':'Bearer '+token} });
      if (r.ok) { const d = await r.json(); playerName = d.user.name || ''; }
    } catch(e) {}
  }
  render();
  if (playerName) go('welcome');
}
init();
</script>
</body>
</html>
